---
title: "Merge"
author: "Constanza Peña"
date: "20-05-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Librerias

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(Hmisc)
library(ggplot2)
library(tidyr)
library(lubridate)
library(scales)
library(fastDummies)
library(tm)
```

```{r}
arreglando_datos <- function(data){
  data <- unique(data)
  names(data) <- tolower(names(data))
  names(data) <- stripWhitespace(names(data))
  names(data) <- gsub("[[:cntrl:]]", " ", names(data))
  #data <- data %>% 
  #  select_if(.predicate=funs(sum(is.na(.))<=as.integer(dim(data)[1]*0.8)))
  return(data)
}


colum_to_palxpal <- function (columna){
  columna <- paste(unlist(columna), collapse =" ")
  columna <- tolower(columna)
  columna <- gsub("[[:cntrl:]]", " ", columna)
  columna <- gsub('(\\s|\r|\n)+',' ',paste(unlist(columna)))
  columna <- stripWhitespace(columna)
  columna <- strsplit(columna, split =  " ") %>% unlist
  columna <- removePunctuation(columna) #se  deshace de la puntuaci?n.
  columna <- removeNumbers(columna)     #En este caso, removemos los n?meros
  columna <- removeWords(columna, words = stopwords("spanish"))
  columna <- columna[columna!=""]
  columna <- columna[columna!=" "]
  return(columna)  
}

fast.rbind <- function(...,method=c("fill","common"),value=NA){
    if("fill"==method[1]) {
        fun1 <- function(x,y,value=NA){
            x[setdiff(colnames(y),colnames(x))] <- value

            y[setdiff(colnames(x),colnames(y))] <- value

            return(rbind(x,y))
        }
    }

    if("common"==method[1]) {
        fun1 <- function(x,y,value=NULL){
          print(paste0("Uno de ",dim(x)," y ",dim(y)))
          
          inter1 <- x %>%
            select(intersect(names(.), names(y)))
          inter2 <- y %>%
                select(intersect(names(.), names(x)))
          print(paste0("queda en uno de ",dim(rbind(inter1,inter2))))
          
          return(rbind(inter1,inter2))
        }
    }
    return(Reduce(function(x,y){fun1(x=x,y=y,value=value)},list(...)))
}

comp_col <- function(x,y,dataf=NULL){
          n_a <- deparse(substitute(x))
          n_b <- deparse(substitute(y))
          
          a <- colnames(x)
          b <- colnames(y)
          
          if (length(a)<length(b)){
            for (i in 1:(length(b)-length(a))){
              a<- append(a, i)
            } 
          }
          else if (length(b)<length(a)){
            for (i in 1:(length(a)-length(b))){
              b<-append(b, i)
            } 
          }
          return(data.frame(n_a=a,n_b=b))
}



```




## Facturaciones

Dado que facturaciones posee la información de todos los clientes, se utilizará como base para unificar a las otras bases como columnas.

```{r, message=FALSE}
path<- "C:/Users/Asus/Documents/GitHub/Entel---Customer-Experience/Data plana/"
dir(path)

m1 <- fread(paste0(path,"7Facturacion/Movil/Fact Movil 2019-1.txt"))
m2 <- fread(paste0(path,"7Facturacion/Movil/Fact Movil 2019-2.txt"))
m3 <- fread(paste0(path,"7Facturacion/Movil/Fact Movil 2020-1.txt"))
m4 <- fread(paste0(path,"7Facturacion/Movil/Fact Movil 2020-2.txt"))
m1
m1 <- arreglando_datos(m1)
m2 <- arreglando_datos(m2)
m3 <- arreglando_datos(m3)
m4 <- arreglando_datos(m4)

facturacion_movil <- fast.rbind(m1, m2, m3, m4,method="common")

churn_movil <- fread(paste0(path,"5Churn/Churn Movil.txt"))
churn_movil <- arreglando_datos(churn_movil)

rmovil_tec_com <-fread(paste0(path,"3Reclamos/reclamos_m_tec_com.txt"))
colnames(rmovil_tec_com)[20] <- "estado2"
rmovil_tec_com <- arreglando_datos(rmovil_tec_com)
```
### Facturación fijo

Nos quedamos solo con columnas útiles, agrupamos por encriptado, e id_mes y reenombramos variables.
```{r}
facturacion_movil1 <- facturacion_movil %>%
  select(encriptado, id_mes, total) %>%
  group_by(encriptado, id_mes) %>%
  summarise(monto = mean(total)) %>%
  rename(mes = id_mes) #, subsegmento_bse = segmento... .groups = 'drop'
facturacion_movil1
```



### Churn Fijo

Nos quedamos solo con columnas útiles, agrupamos por encriptado, e id_mes y reenombramos variables.
```{r}

churn_movil1 <- churn_movil %>%
  select(c(encriptado, id_dia)) %>% # movimiento, desc_plan,negocio,`sub segmento`))
  mutate(churn = 1) %>%
  rename(mes = id_dia)#, subsegmento_bse = `sub segmento`#, desc_movimiento_accf =movimiento, plan=desc_plan

churn_movil1 <- churn_movil1  %>%
  group_by(encriptado, mes) %>%
  summarise_all(sum)

```

## Reclamos comerciales

```{r}
rmovil_tec_com1 <- rmovil_tec_com %>%
  select(encriptado, fecha_de_la_notificacion, #fecha_de_cierre, #causa,segmento_fijo
          reclamo, estado)%>%
  rename(mes = fecha_de_la_notificacion,tipo_reclamo=reclamo)
rmovil_tec_com1
```

```{r}
rmovil_tec_com1$mes <- as.Date(rmovil_tec_com1$mes, format = '%d-%m-%Y')
#rmovil_tec_com1$fecha_de_cierre <- as.Date(rmovil_tec_com1$fecha_de_cierre, format = '%d-%m-%Y')
rmovil_tec_com1 <- rmovil_tec_com1 %>%
  mutate(mes = format(mes, '%Y%m'))

rmovil_tec_com1$reclamo <- 1
#rmovil_tec_com1 <- dummy_cols(rmovil_tec_com1, select_columns = 'estado',
#                              remove_selected_columns = TRUE)

```


```{r}
facturacion_movil1
churn_movil1
rmovil_tec_com1
```

LEFT JOIN

```{r}
#rmovil_tec_com1$subsegmento_bse <- tolower(rmovil_tec_com1$subsegmento_bse)
#churn_movil1$subsegmento_bse <- tolower(churn_movil1$subsegmento_bse)
#facturacion_movil1$subsegmento_bse <- tolower(facturacion_movil1$subsegmento_bse)

unif <- merge(facturacion_movil1, churn_movil1,
              by=c('encriptado', 'mes'),
              all.x = TRUE)

#describe(unif)
unif2 <- merge(unif, rmovil_tec_com1,
              by=c('encriptado', 'mes'),
              all.x = TRUE)
unif2
unif2$churn[is.na(unif2$churn)] <- 0
unif2$reclamo[is.na(unif2$reclamo)] <- 0
View(unif2)
```



```{r, height = 15, width = 10}
unif_e %>%
  filter(RECLAMOS_TEC <=10) %>%
  ggplot(., aes(x=factor(RECLAMOS_TEC), fill = factor(ENOJADO)))+
    geom_bar(position = 'fill')+
    facet_wrap(SUBSEGMENTO_BSE ~ ., ncol = 2)
```

```{r, height = 20, width = 8}
unif_e %>%
  filter(RECLAMOS_VALIDOS <=5) %>%
  ggplot(., aes(x=factor(RECLAMOS_VALIDOS), fill = factor(ENOJADO)))+
    geom_bar(position = 'fill')+
    facet_wrap(SUBSEGMENTO_BSE ~ ., ncol = 2)
```



```{r, height = 15, width = 10}
unif_e %>%
  filter(RECLAMOS_VALIDOS <=5, MONTO>=0, MONTO <= 50000) %>%
  ggplot(., aes(x=factor(RECLAMOS_TEC), y=MONTO))+
  geom_boxplot()+
  facet_wrap(SUBSEGMENTO_BSE ~ ., ncol = 2)
```


```{r}
u <- unif2
```


```{r}
unif <- unif %>%
  filter(Monto > 0) %>%
  mutate(grupo = ifelse(SUBSEGMENTO_BSE == SEGMENTO, 1, 0))

unif$grupo <- as.factor(unif$grupo)
```



```{r}
lil_unif <- sample_n(unif, 500000)

lil_unif <- lil_unif %>%
  filter(Monto > 0, Monto <= 1000000)

rm(list = c("unif"))
rm(list = c("facturacion_d", 'churn_fijo2'))
```

```{r, width = 10}
ggplot(unif, aes(SUBSEGMENTO_BSE, group = factor(CHURN))) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
          geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
          scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") +
          facet_grid(~factor(CHURN))+
          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                legend.position = "none")
```

```{r, width = 10}
lil_unif %>%
  filter(Monto < 250000, Monto > 0) %>%
  ggplot(., aes(y = SUBSEGMENTO_BSE, x = Monto, fill = SUBSEGMENTO_BSE))+
    geom_boxplot()+
    facet_grid(factor(CHURN) ~ .)
```

```{r}
lil_unif %>%
  filter(Monto < 50000, Monto > 0) %>%
  ggplot(., aes(x=Monto, fill=SUBSEGMENTO_BSE))+
    geom_density()+
    facet_grid(SUBSEGMENTO_BSE ~ factor(CHURN))
```

